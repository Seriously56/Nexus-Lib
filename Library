-- Custom Combined UI Library
local cloneref = (cloneref or function(instance) return instance end)
local UserInputService = cloneref(game:GetService('UserInputService'))
local TextService = cloneref(game:GetService('TextService'))
local CoreGui = cloneref(game:GetService('CoreGui'))
local RunService = cloneref(game:GetService('RunService'))
local TweenService = cloneref(game:GetService('TweenService'))
local Players = cloneref(game:GetService('Players'))

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

-- Custom UI Library
local CustomUI = {
    Toggles = {},
    Options = {},
    Labels = {},
    Buttons = {},
    Registry = {},
    RegistryMap = {},
    Signals = {},
    OpenedFrames = {},
    UnloadSignals = {}
}

-- Theme System (From Milenium)
CustomUI.Themes = {
    Dark = {
        MainColor = Color3.fromRGB(28, 28, 28),
        BackgroundColor = Color3.fromRGB(20, 20, 20),
        AccentColor = Color3.fromRGB(155, 150, 219),
        OutlineColor = Color3.fromRGB(50, 50, 50),
        FontColor = Color3.fromRGB(255, 255, 255),
        RiskColor = Color3.fromRGB(255, 50, 50)
    },
    Light = {
        MainColor = Color3.fromRGB(240, 240, 240),
        BackgroundColor = Color3.fromRGB(255, 255, 255),
        AccentColor = Color3.fromRGB(85, 120, 255),
        OutlineColor = Color3.fromRGB(200, 200, 200),
        FontColor = Color3.fromRGB(30, 30, 30),
        RiskColor = Color3.fromRGB(220, 50, 50)
    }
}

-- Apply current theme
CustomUI.CurrentTheme = CustomUI.Themes.Dark
for key, value in pairs(CustomUI.CurrentTheme) do
    CustomUI[key] = value
end

-- Screen GUI Setup
CustomUI.ScreenGui = Instance.new('ScreenGui')
CustomUI.ScreenGui.Name = "CustomUILibrary"
CustomUI.ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
CustomUI.ScreenGui.DisplayOrder = 999
CustomUI.ScreenGui.ResetOnSpawn = false

if gethui then
    CustomUI.ScreenGui.Parent = gethui()
elseif syn and syn.protect_gui then
    syn.protect_gui(CustomUI.ScreenGui)
    CustomUI.ScreenGui.Parent = CoreGui
else
    CustomUI.ScreenGui.Parent = CoreGui
end

-- Utility Functions (Combined from both libraries)
function CustomUI:Create(Class, Properties)
    local Instance = typeof(Class) == "string" and Instance.new(Class) or Class
    for Property, Value in pairs(Properties) do
        Instance[Property] = Value
    end
    return Instance
end

function CustomUI:Tween(Object, Properties, Duration, Style)
    local TweenInfo = TweenInfo.new(Duration or 0.25, Style or Enum.EasingStyle.Quint)
    local Tween = TweenService:Create(Object, TweenInfo, Properties)
    Tween:Play()
    return Tween
end

function CustomUI:AddToRegistry(Instance, Properties)
    local Data = {
        Instance = Instance,
        Properties = Properties
    }
    table.insert(self.Registry, Data)
    self.RegistryMap[Instance] = Data
end

function CustomUI:MouseInFrame(Frame)
    local MousePos = UserInputService:GetMouseLocation()
    local AbsPos, AbsSize = Frame.AbsolutePosition, Frame.AbsoluteSize
    return MousePos.X >= AbsPos.X and MousePos.X <= AbsPos.X + AbsSize.X and
           MousePos.Y >= AbsPos.Y and MousePos.Y <= AbsPos.Y + AbsSize.Y
end

function CustomUI:MakeDraggable(Frame, Handle)
    Handle = Handle or Frame
    local Dragging, DragInput, DragStart, StartPos
    
    Handle.InputBegan:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseButton1 then
            Dragging = true
            DragStart = Input.Position
            StartPos = Frame.Position
            
            local Connection
            Connection = Input.Changed:Connect(function()
                if Input.UserInputState == Enum.UserInputState.End then
                    Dragging = false
                    Connection:Disconnect()
                end
            end)
        end
    end)
    
    Handle.InputChanged:Connect(function(Input)
        if Input.UserInputType == Enum.UserInputType.MouseMovement then
            DragInput = Input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(Input)
        if Input == DragInput and Dragging then
            local Delta = Input.Position - DragStart
            Frame.Position = UDim2.new(
                StartPos.X.Scale,
                StartPos.X.Offset + Delta.X,
                StartPos.Y.Scale,
                StartPos.Y.Offset + Delta.Y
            )
        end
    end)
end

-- Window Creation (Milenium-style with Linoria features)
function CustomUI:CreateWindow(Config)
    Config = Config or {}
    local Window = {
        Tabs = {},
        CurrentTab = nil
    }
    
    -- Main Window Frame
    local MainFrame = self:Create("Frame", {
        Name = "MainWindow",
        BackgroundColor3 = self.MainColor,
        BorderColor3 = self.AccentColor,
        BorderSizePixel = 2,
        Position = Config.Position or UDim2.new(0.5, -300, 0.5, -200),
        Size = Config.Size or UDim2.new(0, 600, 0, 450),
        ClipsDescendants = true,
        Parent = self.ScreenGui
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = MainFrame
    })
    
    -- Title Bar (Milenium-style)
    local TitleBar = self:Create("Frame", {
        Name = "TitleBar",
        BackgroundColor3 = self.BackgroundColor,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 40),
        Parent = MainFrame
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = TitleBar
    })
    
    local TitleLabel = self:Create("TextLabel", {
        Name = "Title",
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 15, 0, 0),
        Size = UDim2.new(0, 200, 1, 0),
        Font = Enum.Font.GothamBold,
        Text = Config.Title or "Custom UI",
        TextColor3 = self.FontColor,
        TextSize = 16,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = TitleBar
    })
    
    -- Tab Buttons (Milenium-style)
    local TabContainer = self:Create("Frame", {
        Name = "TabContainer",
        BackgroundColor3 = self.BackgroundColor,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 40),
        Size = UDim2.new(1, 0, 0, 50),
        Parent = MainFrame
    })
    
    local TabListLayout = self:Create("UIListLayout", {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 5),
        Parent = TabContainer
    })
    
    -- Content Area
    local ContentFrame = self:Create("Frame", {
        Name = "Content",
        BackgroundColor3 = self.MainColor,
        BorderSizePixel = 0,
        Position = UDim2.new(0, 0, 0, 90),
        Size = UDim2.new(1, 0, 1, -90),
        Parent = MainFrame
    })
    
    -- Make draggable via title bar
    self:MakeDraggable(MainFrame, TitleBar)
    
    -- Window Methods
    function Window:AddTab(TabName, Icon)
        local Tab = {
            Name = TabName,
            Elements = {}
        }
        
        -- Tab Button (Milenium-style)
        local TabButton = self:Create("TextButton", {
            Name = TabName .. "Tab",
            BackgroundColor3 = self.BackgroundColor,
            BorderSizePixel = 0,
            Size = UDim2.new(0, 120, 0, 40),
            AutoButtonColor = false,
            Text = "",
            Parent = TabContainer
        })
        
        self:Create("UICorner", {
            CornerRadius = UDim.new(0, 6),
            Parent = TabButton
        })
        
        local ButtonLabel = self:Create("TextLabel", {
            BackgroundTransparency = 1,
            Size = UDim2.new(1, 0, 1, 0),
            Font = Enum.Font.Gotham,
            Text = TabName,
            TextColor3 = self.FontColor,
            TextSize = 14,
            Parent = TabButton
        })
        
        -- Tab Content
        local TabContent = self:Create("ScrollingFrame", {
            Name = TabName .. "Content",
            BackgroundTransparency = 1,
            BorderSizePixel = 0,
            Size = UDim2.new(1, 0, 1, 0),
            CanvasSize = UDim2.new(0, 0, 0, 0),
            ScrollBarThickness = 3,
            ScrollBarImageColor3 = self.AccentColor,
            Visible = false,
            Parent = ContentFrame
        })
        
        local ContentLayout = self:Create("UIListLayout", {
            Padding = UDim.new(0, 10),
            SortOrder = Enum.SortOrder.LayoutOrder,
            Parent = TabContent
        })
        
        ContentLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
            TabContent.CanvasSize = UDim2.new(0, 0, 0, ContentLayout.AbsoluteContentSize.Y)
        end)
        
        -- Tab Methods
        function Tab:Show()
            if Window.CurrentTab then
                Window.CurrentTab:Hide()
            end
            
            -- Update tab button appearance
            self:Tween(TabButton, {BackgroundColor3 = self.AccentColor})
            self:Tween(ButtonLabel, {TextColor3 = Color3.new(1, 1, 1)})
            
            TabContent.Visible = true
            Window.CurrentTab = Tab
        end
        
        function Tab:Hide()
            self:Tween(TabButton, {BackgroundColor3 = self.BackgroundColor})
            self:Tween(ButtonLabel, {TextColor3 = self.FontColor})
            TabContent.Visible = false
        end
        
        function Tab:AddSection(SectionName)
            local Section = {
                Name = SectionName,
                Container = nil
            }
            
            -- Section Frame (Linoria-style groupbox)
            local SectionFrame = self:Create("Frame", {
                Name = SectionName .. "Section",
                BackgroundColor3 = self.BackgroundColor,
                BorderColor3 = self.OutlineColor,
                BorderSizePixel = 1,
                Size = UDim2.new(1, -20, 0, 0),
                Parent = TabContent
            })
            
            self:Create("UICorner", {
                CornerRadius = UDim.new(0, 6),
                Parent = SectionFrame
            })
            
            local SectionHeader = self:Create("Frame", {
                Name = "Header",
                BackgroundColor3 = self.MainColor,
                BorderSizePixel = 0,
                Size = UDim2.new(1, 0, 0, 30),
                Parent = SectionFrame
            })
            
            self:Create("UICorner", {
                CornerRadius = UDim.new(0, 6),
                Parent = SectionHeader
            })
            
            local HeaderLabel = self:Create("TextLabel", {
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 10, 0, 0),
                Size = UDim2.new(1, -10, 1, 0),
                Font = Enum.Font.Gotham,
                Text = SectionName,
                TextColor3 = self.FontColor,
                TextSize = 14,
                TextXAlignment = Enum.TextXAlignment.Left,
                Parent = SectionHeader
            })
            
            local ElementsContainer = self:Create("Frame", {
                Name = "Elements",
                BackgroundTransparency = 1,
                Position = UDim2.new(0, 0, 0, 35),
                Size = UDim2.new(1, 0, 0, 0),
                Parent = SectionFrame
            })
            
            local ElementsLayout = self:Create("UIListLayout", {
                Padding = UDim.new(0, 8),
                SortOrder = Enum.SortOrder.LayoutOrder,
                Parent = ElementsContainer
            })
            
            ElementsLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                local ContentSize = ElementsLayout.AbsoluteContentSize.Y
                ElementsContainer.Size = UDim2.new(1, 0, 0, ContentSize)
                SectionFrame.Size = UDim2.new(1, -20, 0, ContentSize + 40)
            end)
            
            -- Section Methods
            function Section:AddToggle(OptionName, Config)
                Config = Config or {}
                local Toggle = {
                    Value = Config.Default or false,
                    Type = "Toggle"
                }
                
                local ToggleFrame = self:Create("Frame", {
                    Name = OptionName .. "Toggle",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 25),
                    Parent = ElementsContainer
                })
                
                local ToggleButton = self:Create("TextButton", {
                    Name = "Toggle",
                    BackgroundColor3 = self.BackgroundColor,
                    BorderColor3 = self.OutlineColor,
                    BorderSizePixel = 1,
                    Position = UDim2.new(0, 0, 0, 0),
                    Size = UDim2.new(0, 40, 0, 20),
                    AutoButtonColor = false,
                    Text = "",
                    Parent = ToggleFrame
                })
                
                self:Create("UICorner", {
                    CornerRadius = UDim.new(0, 4),
                    Parent = ToggleButton
                })
                
                local ToggleIndicator = self:Create("Frame", {
                    Name = "Indicator",
                    BackgroundColor3 = self.FontColor,
                    Position = UDim2.new(0, 2, 0, 2),
                    Size = UDim2.new(0, 16, 0, 16),
                    Parent = ToggleButton
                })
                
                self:Create("UICorner", {
                    CornerRadius = UDim.new(0, 3),
                    Parent = ToggleIndicator
                })
                
                local ToggleLabel = self:Create("TextLabel", {
                    BackgroundTransparency = 1,
                    Position = UDim2.new(0, 50, 0, 0),
                    Size = UDim2.new(1, -50, 1, 0),
                    Font = Enum.Font.Gotham,
                    Text = OptionName,
                    TextColor3 = self.FontColor,
                    TextSize = 14,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    Parent = ToggleFrame
                })
                
                -- Toggle Methods
                function Toggle:SetValue(Value)
                    Toggle.Value = Value
                    if Value then
                        self:Tween(ToggleButton, {BackgroundColor3 = self.AccentColor})
                        self:Tween(ToggleIndicator, {
                            Position = UDim2.new(1, -18, 0, 2),
                            BackgroundColor3 = Color3.new(1, 1, 1)
                        })
                    else
                        self:Tween(ToggleButton, {BackgroundColor3 = self.BackgroundColor})
                        self:Tween(ToggleIndicator, {
                            Position = UDim2.new(0, 2, 0, 2),
                            BackgroundColor3 = self.FontColor
                        })
                    end
                    
                    if Config.Callback then
                        Config.Callback(Value)
                    end
                end
                
                -- Connect click event
                ToggleButton.MouseButton1Click:Connect(function()
                    Toggle:SetValue(not Toggle.Value)
                end)
                
                -- Initialize
                Toggle:SetValue(Toggle.Value)
                self.Toggles[OptionName] = Toggle
                
                return Toggle
            end
            
            function Section:AddSlider(OptionName, Config)
                Config = Config or {}
                local Slider = {
                    Value = Config.Default or Config.Min or 0,
                    Min = Config.Min or 0,
                    Max = Config.Max or 100,
                    Type = "Slider"
                }
                
                local SliderFrame = self:Create("Frame", {
                    Name = OptionName .. "Slider",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 50),
                    Parent = ElementsContainer
                })
                
                local SliderLabel = self:Create("TextLabel", {
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 20),
                    Font = Enum.Font.Gotham,
                    Text = OptionName,
                    TextColor3 = self.FontColor,
                    TextSize = 14,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    Parent = SliderFrame
                })
                
                local ValueLabel = self:Create("TextLabel", {
                    BackgroundTransparency = 1,
                    Position = UDim2.new(1, -60, 0, 0),
                    Size = UDim2.new(0, 60, 0, 20),
                    Font = Enum.Font.Gotham,
                    Text = tostring(Slider.Value),
                    TextColor3 = self.FontColor,
                    TextSize = 12,
                    TextXAlignment = Enum.TextXAlignment.Right,
                    Parent = SliderFrame
                })
                
                local SliderTrack = self:Create("Frame", {
                    Name = "Track",
                    BackgroundColor3 = self.BackgroundColor,
                    BorderColor3 = self.OutlineColor,
                    BorderSizePixel = 1,
                    Position = UDim2.new(0, 0, 0, 25),
                    Size = UDim2.new(1, 0, 0, 15),
                    Parent = SliderFrame
                })
                
                self:Create("UICorner", {
                    CornerRadius = UDim.new(0, 4),
                    Parent = SliderTrack
                })
                
                local SliderFill = self:Create("Frame", {
                    Name = "Fill",
                    BackgroundColor3 = self.AccentColor,
                    Size = UDim2.new(0, 0, 1, 0),
                    Parent = SliderTrack
                })
                
                self:Create("UICorner", {
                    CornerRadius = UDim.new(0, 4),
                    Parent = SliderFill
                })
                
                local SliderButton = self:Create("TextButton", {
                    Name = "SliderButton",
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 1, 0),
                    Text = "",
                    Parent = SliderTrack
                })
                
                -- Slider Methods
                function Slider:SetValue(Value)
                    Value = math.clamp(Value, self.Min, self.Max)
                    Slider.Value = Value
                    
                    local Percentage = (Value - self.Min) / (self.Max - self.Min)
                    SliderFill.Size = UDim2.new(Percentage, 0, 1, 0)
                    ValueLabel.Text = tostring(Value)
                    
                    if Config.Callback then
                        Config.Callback(Value)
                    end
                end
                
                -- Slider interaction
                local Dragging = false
                
                SliderButton.MouseButton1Down:Connect(function()
                    Dragging = true
                end)
                
                UserInputService.InputEnded:Connect(function(Input)
                    if Input.UserInputType == Enum.UserInputType.MouseButton1 then
                        Dragging = false
                    end
                end)
                
                SliderTrack.MouseMoved:Connect(function()
                    if Dragging then
                        local MousePos = UserInputService:GetMouseLocation()
                        local TrackPos = SliderTrack.AbsolutePosition
                        local TrackSize = SliderTrack.AbsoluteSize
                        
                        local RelativeX = math.clamp((MousePos.X - TrackPos.X) / TrackSize.X, 0, 1)
                        local Value = self.Min + (RelativeX * (self.Max - self.Min))
                        
                        if Config.Rounding then
                            Value = math.floor(Value / Config.Rounding) * Config.Rounding
                        end
                        
                        Slider:SetValue(Value)
                    end
                end)
                
                -- Initialize
                Slider:SetValue(Slider.Value)
                self.Options[OptionName] = Slider
                
                return Slider
            end
            
            function Section:AddButton(OptionName, Config)
                Config = Config or {}
                local Button = {
                    Type = "Button"
                }
                
                local ButtonFrame = self:Create("TextButton", {
                    Name = OptionName .. "Button",
                    BackgroundColor3 = self.BackgroundColor,
                    BorderColor3 = self.OutlineColor,
                    BorderSizePixel = 1,
                    Size = UDim2.new(1, 0, 0, 30),
                    AutoButtonColor = false,
                    Text = OptionName,
                    TextColor3 = self.FontColor,
                    Font = Enum.Font.Gotham,
                    TextSize = 14,
                    Parent = ElementsContainer
                })
                
                self:Create("UICorner", {
                    CornerRadius = UDim.new(0, 4),
                    Parent = ButtonFrame
                })
                
                -- Hover effects
                ButtonFrame.MouseEnter:Connect(function()
                    self:Tween(ButtonFrame, {BackgroundColor3 = self.AccentColor})
                    self:Tween(ButtonFrame, {TextColor3 = Color3.new(1, 1, 1)})
                end)
                
                ButtonFrame.MouseLeave:Connect(function()
                    self:Tween(ButtonFrame, {BackgroundColor3 = self.BackgroundColor})
                    self:Tween(ButtonFrame, {TextColor3 = self.FontColor})
                end)
                
                -- Click event
                ButtonFrame.MouseButton1Click:Connect(function()
                    if Config.Callback then
                        Config.Callback()
                    end
                end)
                
                self.Buttons[OptionName] = Button
                return Button
            end
            
            function Section:AddLabel(Text)
                local Label = self:Create("TextLabel", {
                    BackgroundTransparency = 1,
                    Size = UDim2.new(1, 0, 0, 20),
                    Font = Enum.Font.Gotham,
                    Text = Text,
                    TextColor3 = self.FontColor,
                    TextSize = 14,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    Parent = ElementsContainer
                })
                
                table.insert(self.Labels, Label)
                return Label
            end
            
            Section.Container = ElementsContainer
            table.insert(Tab.Elements, Section)
            
            return Section
        end
        
        -- Show first tab by default
        if #Window.Tabs == 0 then
            Tab:Show()
        end
        
        TabButton.MouseButton1Click:Connect(function()
            Tab:Show()
        end)
        
        table.insert(Window.Tabs, Tab)
        return Tab
    end
    
    function Window:ToggleVisibility()
        MainFrame.Visible = not MainFrame.Visible
    end
    
    Window.MainFrame = MainFrame
    return Window
end

-- Notification System (Linoria-style)
function CustomUI:Notify(Title, Message, Duration)
    Duration = Duration or 5
    
    local Notification = self:Create("Frame", {
        Name = "Notification",
        BackgroundColor3 = self.MainColor,
        BorderColor3 = self.AccentColor,
        BorderSizePixel = 2,
        Position = UDim2.new(1, -320, 0, 20),
        Size = UDim2.new(0, 300, 0, 0),
        ClipsDescendants = true,
        Parent = self.ScreenGui
    })
    
    self:Create("UICorner", {
        CornerRadius = UDim.new(0, 8),
        Parent = Notification
    })
    
    local TitleLabel = self:Create("TextLabel", {
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 10),
        Size = UDim2.new(1, -20, 0, 20),
        Font = Enum.Font.GothamBold,
        Text = Title or "Notification",
        TextColor3 = self.FontColor,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = Notification
    })
    
    local MessageLabel = self:Create("TextLabel", {
        BackgroundTransparency = 1,
        Position = UDim2.new(0, 10, 0, 35),
        Size = UDim2.new(1, -20, 0, 0),
        Font = Enum.Font.Gotham,
        Text = Message or "",
        TextColor3 = self.FontColor,
        TextSize = 12,
        TextWrapped = true,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextYAlignment = Enum.TextYAlignment.Top,
        Parent = Notification
    })
    
    -- Calculate size
    local TextBounds = TextService:GetTextSize(Message, 12, Enum.Font.Gotham, Vector2.new(280, math.huge))
    local Height = math.max(70, TextBounds.Y + 50)
    
    -- Animate in
    self:Tween(Notification, {
        Size = UDim2.new(0, 300, 0, Height)
    }, 0.3)
    
    -- Auto-remove after duration
    task.delay(Duration, function()
        self:Tween(Notification, {
            Size = UDim2.new(0, 300, 0, 0)
        }, 0.3)
        
        task.wait(0.3)
        Notification:Destroy()
    end)
    
    return Notification
end

-- Theme Management
function CustomUI:SetTheme(ThemeName)
    if self.Themes[ThemeName] then
        self.CurrentTheme = self.Themes[ThemeName]
        for key, value in pairs(self.CurrentTheme) do
            self[key] = value
        end
        self:UpdateColors()
    end
end

function CustomUI:UpdateColors()
    for _, Data in pairs(self.Registry) do
        for Property, ColorKey in pairs(Data.Properties) do
            if self[ColorKey] then
                Data.Instance[Property] = self[ColorKey]
            end
        end
    end
end

-- Cleanup
function CustomUI:Unload()
    for _, Signal in pairs(self.Signals) do
        Signal:Disconnect()
    end
    
    for _, Callback in pairs(self.UnloadSignals) do
        Callback()
    end
    
    self.ScreenGui:Destroy()
end

function CustomUI:OnUnload(Callback)
    table.insert(self.UnloadSignals, Callback)
end

-- Make library globally accessible
getgenv().CustomUI = CustomUI

return CustomUI
